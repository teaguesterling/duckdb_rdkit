# Require statement will ensure this test is run with this extension loaded
require duckdb_rdkit


# setup
statement ok
CREATE TABLE molecules (m Mol);
INSERT INTO molecules VALUES ('c1ccccc1'), ('CCO'), ('c1ccncc1'), ('c1ccc(-c2ccccn2)nc1'), ('CCO')


# check that exact_match works while a simple '=' operator fails to 
# find the same molecule
statement ok
INSERT INTO molecules VALUES ('Cc1ccccc1');

# '=' operator fails to find the same molecule 
query I
SELECT m from molecules WHERE m='c1ccccc1C';
----

# exact_match function successfully finds the molecule
# and returns it in the same SMILES format it was entered as
query I
SELECT m from molecules WHERE is_exact_match(m,'c1ccccc1C');
----
Cc1ccccc1

# returns multiple matches
query I
SELECT m FROM molecules WHERE is_exact_match(m,'CCO');
----
CCO
CCO

# ============================================================================
# is_substruct tests - substructure searching
# ============================================================================

# benzene is a substructure of toluene
query I
SELECT is_substruct('Cc1ccccc1'::mol, 'c1ccccc1'::mol);
----
true

# toluene is NOT a substructure of benzene (has extra methyl)
query I
SELECT is_substruct('c1ccccc1'::mol, 'Cc1ccccc1'::mol);
----
false

# ethanol contains C-O substructure
query I
SELECT is_substruct('CCO'::mol, 'CO'::mol);
----
true

# find all molecules containing benzene ring
query I rowsort
SELECT m FROM molecules WHERE is_substruct(m, 'c1ccccc1'::mol);
----
Cc1ccccc1
c1ccccc1

# find all molecules containing pyridine ring
query I rowsort
SELECT m FROM molecules WHERE is_substruct(m, 'c1ccncc1'::mol);
----
c1ccc(-c2ccccn2)nc1
c1ccncc1

# bipyridine contains pyridine as substructure
query I
SELECT is_substruct('c1ccc(-c2ccccn2)nc1'::mol, 'c1ccncc1'::mol);
----
true

# same molecule is substructure of itself
query I
SELECT is_substruct('CCO'::mol, 'CCO'::mol);
----
true

# SMARTS-like pattern: any aromatic ring (using benzene as proxy)
query I
SELECT COUNT(*) FROM molecules WHERE is_substruct(m, 'c1ccccc1'::mol);
----
2

# hydroxyl group substructure search
query I rowsort
SELECT m FROM molecules WHERE is_substruct(m, 'O'::mol);
----
CCO
CCO

# ============================================================================
# substruct_count tests - count number of substructure matches
# ============================================================================

# benzene has 6 carbon atoms that match the 'C' pattern
query I
SELECT substruct_count('c1ccccc1'::mol, 'C'::mol);
----
6

# toluene has 7 carbons total
query I
SELECT substruct_count('Cc1ccccc1'::mol, 'C'::mol);
----
7

# ethane has 2 carbon matches
query I
SELECT substruct_count('CC'::mol, 'C'::mol);
----
2

# naphthalene - count benzene rings (fused rings share atoms)
query I
SELECT substruct_count('c1ccc2ccccc2c1'::mol, 'c1ccccc1'::mol);
----
2

# count hydroxyl groups in glycerol (3 OH groups)
query I
SELECT substruct_count('OCC(O)CO'::mol, 'O'::mol);
----
3

# no match returns 0
query I
SELECT substruct_count('c1ccccc1'::mol, 'N'::mol);
----
0

# substruct_count works with UmbraMol too
query I
SELECT substruct_count(umbramol_from_smiles('c1ccccc1'), umbramol_from_smiles('C'));
----
6

