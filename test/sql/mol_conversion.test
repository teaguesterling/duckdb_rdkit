# name: test/sql/duckdb_rdkit.test
# description: test duckdb_rdkit extension
# group: [duckdb_rdkit]

# Before we load the extension, this will fail
statement error
SELECT mol_from_smiles('CC');
----
Catalog Error: Scalar Function with name mol_from_smiles does not exist!

# Require statement will ensure this test is run with this extension loaded
require duckdb_rdkit

# for the tests:
# a non canonical benzene is used 
# because there is a Mol to VARCHAR cast, we will see a SMILES string coming back
# in order to confirm that the data is being transformed by RDKit internally,
# we use a non RDKIT canonical benzene, and expect a RDKit canonicalized benzene
# to be returned

# mol_from_smiles will return a SMILES string becuase cast from MolToVarChar will happen
query I
SELECT mol_from_smiles('C1=CC=CC=C1');
----
c1ccccc1

# mol_from_smiles on invalid SMILES should return NULL
# a warning will be printed to the user, but can't test that print out
# with sqllogictest
query I
SELECT mol_from_smiles('NOTASMILES');
----
NULL


# mol_to_smiles can convert a binary molecule back to the SMILES
query I
SELECT mol_to_smiles(mol_from_smiles('C1=CC=CC=C1'))
----
c1ccccc1

# ::mol cast is supported
query I
SELECT 'C1=CC=CC=C1'::mol;
----
c1ccccc1

# ::mol cast with invalid SMILES throws an error (consistent with DuckDB native types)
statement error
SELECT 'NOTASMILES'::mol;
----
Conversion Error: Could not convert string 'NOTASMILES' to Mol

# TRY_CAST returns NULL for invalid SMILES without error
query I
SELECT TRY_CAST('NOTASMILES' AS mol);
----
NULL

# umbramol_to_mol extracts the pure RDKit pickle from UmbraMol format
# When displayed, Mol is cast to VARCHAR (SMILES)
query I
SELECT umbramol_to_mol('C'::umbramol);
----
C

# mol_to_umbramol converts pure Mol to UmbraMol format
# When displayed, UmbraMol is cast to VARCHAR (SMILES)
query I
SELECT mol_to_umbramol('C'::mol);
----
C

# Roundtrip: Mol -> UmbraMol -> Mol preserves molecule
query I
SELECT umbramol_to_mol(mol_to_umbramol('c1ccccc1'::mol));
----
c1ccccc1

# Roundtrip: UmbraMol -> Mol -> UmbraMol preserves molecule
query I
SELECT mol_to_umbramol(umbramol_to_mol('CCO'::umbramol));
----
CCO

# Verify UmbraMol adds exactly 8 bytes (DalkeFP prefix) using BLOB cast
query I
SELECT octet_length(mol_to_umbramol('C'::mol)::blob) - octet_length('C'::mol::blob);
----
8

# Mol and UmbraMol can be cast to BLOB for raw binary access
query I
SELECT octet_length('C'::mol::blob) > 0;
----
true

query I
SELECT octet_length('C'::umbramol::blob) > 0;
----
true

# ============================================================================
# mol_to_smarts tests
# ============================================================================

# mol_to_smarts converts a molecule to SMARTS notation
query I
SELECT mol_to_smarts(mol_from_smiles('C'));
----
[#6]

query I
SELECT mol_to_smarts(mol_from_smiles('CCO'));
----
[#6]-[#6]-[#8]

query I
SELECT mol_to_smarts(mol_from_smiles('c1ccccc1'));
----
[#6]1:[#6]:[#6]:[#6]:[#6]:[#6]:1

# mol_to_smarts works with UmbraMol too
query I
SELECT mol_to_smarts(umbramol_from_smiles('C'));
----
[#6]

# ============================================================================
# is_valid_smiles tests
# ============================================================================

query I
SELECT is_valid_smiles('CCO');
----
true

query I
SELECT is_valid_smiles('c1ccccc1');
----
true

query I
SELECT is_valid_smiles('NOTASMILES');
----
false

# Empty string is considered valid by RDKit (returns empty molecule)
query I
SELECT is_valid_smiles('');
----
true

# Pentavalent carbon is invalid
query I
SELECT is_valid_smiles('C(C)(C)(C)(C)C');
----
false

# ============================================================================
# is_valid_smarts tests
# ============================================================================

query I
SELECT is_valid_smarts('[#6]');
----
true

query I
SELECT is_valid_smarts('[CX4]');
----
true

query I
SELECT is_valid_smarts('c1ccccc1');
----
true

query I
SELECT is_valid_smarts('NOT_SMARTS!!!');
----
false

# Empty string is considered valid by RDKit (returns empty query)
query I
SELECT is_valid_smarts('');
----
true

